## Fitting stretagy
The full fitting pipeline of S<sup>3</sup>Fit is shown in the following flowchart. 
<p align="center"> <img src="https://github.com/user-attachments/assets/96901c47-8c44-4399-948f-3015b6a2cb58" height="800">

The core processes of S<sup>3</sup>Fit are <ins>**Create model spectra**</ins> and <ins>**Fit models to data**</ins> in the flowchart. 
The code separate the values related to the normalization factors of models (i.e., flux or luminosity of each model component)
from the other parameters that control shapes of models (e.g., line width, stellar population age), 
and hereafter the word "parameters" only denote the later type variables. 

For a given group of parameters, the normalization factors of models are obtained by solving the linear least-square problem, with the function `scipy.optimize.lsq_linear`. 
The corresponding model spectra and the $\chi^2$ value are then calculated with the normalization factors.
The best-fit parameters are obtained by solving the non-linear least-square problem to minimize $\chi^2$, with the function `scipy.optimize.least_squares`
and the Trust Region Reflective algorithm (read [the page][8] for details of the algorithm). 
The stretagy, which combines the solvers of linear and non-linear least-square problem, 
runs faster than the method to only solve non-linear least-square problem for all variables (i.e., both of normalization factors and shape-controlled parameters); 
and also runs faster than the method 
that calculate $\chi^2$ for all combinations of parameters in the model parameter grids, especially when the number of parameters i huge. 

The solution of `scipy.optimize.least_squares` is indeed the values for the local minimum $\chi^2$, which could be sensitive to the initial values pf parameters. 
In order to reduce the effect, the full fitting pipeline can be iterated with multiple loops (adjusted with `num_mock_loops` in the input).
In each loop, the initial parameters are randomly generated.
A mocked data, which is generated by adding random noise (scaled with the measurement errors) to the observed data, 
is used each iteration. 
The results from all iterations can be used to estimate the uncertainty of each parameters, 
and to examine if there is a secondary solution in the parameter space. 

Since there could be several tens of parameters, it can be hard for the algorithm to find the 
best-fit values for all models with randomly initialized input parameters. 
In order to address the issue, the pipeline is performed in three (if only spectrum) or four cycles (if fit both of spectrum and photometric SED). 
In the initial cycle, 
the 

An example of the fitting result is shown in the following plots. 
<p align="center"> <img src="https://github.com/user-attachments/assets/683f5837-d364-4a53-8113-a05d56f9ef5b" width="600" height="600">
